<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é—‡é‹ã‚²ãƒ¼ãƒ  (å³æ™‚é–‹ç¤ºver)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #222; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #main-area { flex: 1; padding: 10px; overflow-y: auto; text-align: center; position: relative; }
        #sidebar { 
            width: 280px; 
            background-color: #2d2d2d; 
            border-left: 1px solid #444; 
            overflow-y: auto; 
            display: none; /* ã‚¹ãƒãƒ›ç”¨ã«åˆæœŸã¯éš ã™ */
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        @media (min-width: 800px) { #sidebar { display: flex; } }

        h1 { margin: 10px 0; font-size: 1.2em; letter-spacing: 2px; }
        
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background-color: #eee; border: none; border-radius: 4px; margin: 10px; color:#333; font-weight: bold;}
        button:hover { background-color: #fff; }
        .hidden { display: none !important; }

        /* å…·æã‚¹ã‚¿ã‚¤ãƒ« */
        .ingredient {
            width: 42px; height: 42px;
            display: inline-flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            font-size: 9px; color: #000; font-weight: bold; overflow: hidden; margin: 3px;
        }
        .shape-sphere { border-radius: 50%; }
        .shape-cube { border-radius: 3px; }
        .shape-pyramid { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); width: 46px; height: 42px; border-radius: 0;}
        
        .color-red { background-color: #ff6b6b; }
        .color-green { background-color: #69f0ae; }
        .color-yellow { background-color: #ffd740; }
        .color-white { background-color: #f5f5f5; border: 1px solid #999; }
        .color-brown { background-color: #795548; border: 1px solid #d7ccc8; color: #fff; }

        /* æ­£ä½“åˆ¤æ˜æ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º */
        .revealed-name-container {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none;
            background-color: rgba(255,255,255,0.3); /* å°‘ã—æ˜ã‚‹ã */
        }
        .revealed-name { 
            font-size: 8px; line-height: 1.1; text-align: center; word-break: break-all; 
            color: #000; text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        #pot-area {
            background-color: #3e2723; border-radius: 50%;
            width: 300px; height: 300px; margin: 10px auto; padding: 20px;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            border: 6px solid #5d4037; box-shadow: inset 0 0 40px #000;
        }

        .player-area {
            border: 1px solid #555; margin: 5px; padding: 5px; border-radius: 8px;
            background-color: #2a2a2a; display: inline-block; vertical-align: top;
            width: 45%; min-height: 80px; font-size: 0.9em;
        }
        .active-turn { border: 2px solid #69f0ae; background-color: #333; box-shadow: 0 0 10px rgba(105, 240, 174, 0.3); }

        #log { margin-top: 20px; color: #aaa; font-size: 0.8em; height: 100px; overflow-y: auto; border-top: 1px solid #444; text-align: left; padding: 10px; font-family: monospace;}
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨ */
        .sidebar-header { padding: 10px; background-color: #222; text-align: center; font-weight: bold; }
        .legend-row { display: flex; align-items: center; margin: 5px 10px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .legend-info { font-size: 0.8em; margin-left: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">å¾—ç‚¹è¡¨</div>
    <div id="legend-container"></div>
</div>

<div id="main-area">
    <h1>é—‡é‹ã‚²ãƒ¼ãƒ  (å³æ™‚é–‹ç¤º)</h1>
    
    <div id="setup-screen">
        <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <select id="player-count" style="padding:10px; font-size:1.2em;">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4" selected>4äºº</option>
            <option value="5">5äºº</option>
            <option value="6">6äºº</option>
        </select>
        <br><br>
        <button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <p style="color:#aaa;"><small>å…¨40å€‹ã®å…·æã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ä½¿ç”¨ã—ã¾ã™</small></p>
    </div>

    <div id="game-screen" class="hidden">
        <h2 id="phase-display">ãƒ•ã‚§ãƒ¼ã‚º2: é‹ã‹ã‚‰ã™ãã†</h2>
        <p id="instruction">æº–å‚™ä¸­...</p>
        
        <div>
            <div id="pot-area"></div>
            <div style="color:#aaa;">é‹ã®æ®‹ã‚Š: <span id="pot-count">0</span> å€‹</div>
        </div>

        <div id="players-container" style="margin-top:10px;"></div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>çµæœç™ºè¡¨</h2>
        <div id="result-list"></div>
        <button onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>

    <div id="log"></div>
</div>

<script>
    /* =========================================
       ãƒ‡ãƒ¼ã‚¿å®šç¾©
       ========================================= */
    const INGREDIENT_DEFINITIONS = [
        { color: 'red', shape: 'sphere', items: [{name:'ãƒˆãƒãƒˆ', score:1, count:2}, {name:'ã„ã¡ã”', score:2, count:1}] },
        { color: 'red', shape: 'pyramid', items: [{name:'ã«ã‚“ã˜ã‚“', score:1, count:3}] },
        { color: 'red', shape: 'cube', items: [{name:'ç”Ÿè‚‰', score:-2, count:2}, {name:'ã‚«ãƒ‹', score:3, count:1}] },
        { color: 'green', shape: 'sphere', items: [{name:'ãƒã‚®', score:1, count:2}, {name:'ã‚­ã‚¦ã‚¤', score:2, count:1}] },
        { color: 'green', shape: 'pyramid', items: [{name:'ã‚­ãƒ£ãƒ™ãƒ„', score:1, count:2}, {name:'ã‚¹ãƒ©ã‚¤ãƒ ', score:-2, count:1}] },
        { color: 'green', shape: 'cube', items: [{name:'ãƒ‹ãƒ©', score:1, count:3}] },
        { color: 'yellow', shape: 'sphere', items: [{name:'ã‚¸ãƒ£ã‚¬ã‚¤ãƒ¢', score:1, count:3}] },
        { color: 'yellow', shape: 'pyramid', items: [{name:'ã‹ã¼ã¡ã‚ƒ', score:1, count:2}, {name:'ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«', score:2, count:1}] },
        { color: 'yellow', shape: 'cube', items: [{name:'åšæšã’', score:1, count:2}, {name:'ã‚¹ãƒãƒ³ã‚¸', score:-2, count:1}] },
        { color: 'white', shape: 'sphere', items: [{name:'ã‚†ã§åµ', score:1, count:2}, {name:'ç™½æ¡ƒ', score:2, count:1}] },
        { color: 'white', shape: 'pyramid', items: [{name:'å¤§æ ¹', score:1, count:2}, {name:'ãƒ‹ãƒ³ãƒ‹ã‚¯', score:1, count:1}] },
        { color: 'white', shape: 'cube', items: [{name:'è±†è…', score:1, count:2}, {name:'é¤…', score:2, count:1}] },
    ];
    const BROWN_ITEMS = [{name:'é»’æ¯›å’Œç‰›', score:4, count:2}, {name:'ã‚´ã‚­ãƒ–ãƒª', score:-4, count:2}];
    const SHAPES = ['sphere', 'cube', 'pyramid'];

    let players = [];
    let potIngredients = [];
    let currentPlayerIndex = 0;
    let phase = 0; // 0:setup, 2:scoop, 3:result

    // ãƒ­ã‚°æ©Ÿèƒ½
    function log(msg) {
        const el = document.getElementById('log');
        const time = new Date().toLocaleTimeString().slice(3,8);
        el.innerHTML = `<div><span style="color:#666">[${time}]</span> ${msg}</div>` + el.innerHTML;
    }

    // å…·æã‚¯ãƒ©ã‚¹
    class Ingredient {
        constructor(shape, color, name, score) {
            this.shape = shape;
            this.color = color;
            this.name = name;
            this.score = score;
            this.isRevealed = false; // åˆæœŸçŠ¶æ…‹ã¯éš ã•ã‚Œã¦ã„ã‚‹
            this.id = Math.random().toString(36).substr(2, 9);
        }

        getElement(onClick, enableClick = true) {
            const el = document.createElement('div');
            el.className = `ingredient shape-${this.shape} color-${this.color}`;
            
            // æ­£ä½“ãŒãƒãƒ¬ã¦ã„ã‚‹å ´åˆã€åå‰ã‚’è¡¨ç¤º
            if(this.isRevealed) {
                el.title = `${this.name} (${this.score}ç‚¹)`;
                el.innerHTML = `<div class="revealed-name-container"><span class="revealed-name">${this.name}<br>(${this.score})</span></div>`;
            } else {
                el.title = `è‰²:${this.color} å½¢:${this.shape}`;
            }

            if (enableClick && onClick) el.onclick = () => onClick(this);
            return el;
        }
    }

    // ãƒ‡ãƒƒã‚­ç”Ÿæˆ
    function generateIngredientDeck() {
        let deck = [];
        INGREDIENT_DEFINITIONS.forEach(def => {
            def.items.forEach(item => {
                for(let i=0; i<item.count; i++) deck.push(new Ingredient(def.shape, def.color, item.name, item.score));
            });
        });
        BROWN_ITEMS.forEach(item => {
            for(let i=0; i<item.count; i++) {
                const randomShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
                deck.push(new Ingredient(randomShape, 'brown', item.name, item.score));
            }
        });
        return deck;
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
        const count = parseInt(document.getElementById('player-count').value);
        players = [];
        for(let i=0; i<count; i++) players.push({ id: i, name: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, bowl: [], score: 0 });

        let allIngredients = generateIngredientDeck();
        allIngredients.sort(() => Math.random() - 0.5);
        
        const requiredIngredients = count * 5;
        potIngredients = allIngredients.slice(0, requiredIngredients);

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        log(`ã‚²ãƒ¼ãƒ é–‹å§‹ï¼å…·ææ•°: ${potIngredients.length}`);
        renderLegend();
        updateBoard();
    }

    // å…·æé¸æŠå‡¦ç†
    function scoopIngredient(ingredient) {
        if (phase === 3) return; // çµ‚äº†å¾Œã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯

        const index = potIngredients.findIndex(i => i.id === ingredient.id);
        if (index === -1) return;
        
        // 1. é‹ã‹ã‚‰å‰Šé™¤
        potIngredients.splice(index, 1);

        // 2. æ­£ä½“ã‚’æ˜ã‹ã™ (â˜…ã“ã“ãŒä¿®æ­£ç‚¹)
        ingredient.isRevealed = true;

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 
        const player = players[currentPlayerIndex];
        player.bowl.push(ingredient);
        
        // ãƒ­ã‚°å‡ºåŠ›
        log(`${player.name} ãŒ <strong>ã€${ingredient.name} (${ingredient.score}ç‚¹)ã€‘</strong> ã‚’ã™ãã„ã¾ã—ãŸ`);

        // ã‚¿ãƒ¼ãƒ³é€ã‚Š
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

        if (potIngredients.length === 0) {
            startResultPhase();
        } else {
            updateBoard();
        }
    }

    // ç”»é¢æ›´æ–°
    function updateBoard() {
        const potEl = document.getElementById('pot-area');
        potEl.innerHTML = '';
        document.getElementById('pot-count').innerText = potIngredients.length;

        // é‹ã®ä¸­èº« (isRevealedã¯false)
        potIngredients.forEach(ing => {
            potEl.appendChild(ing.getElement((i) => scoopIngredient(i), true));
        });

        const playersEl = document.getElementById('players-container');
        playersEl.innerHTML = '';
        players.forEach((p, idx) => {
            const pDiv = document.createElement('div');
            pDiv.className = `player-area ${idx === currentPlayerIndex ? 'active-turn' : ''}`;
            
            let html = `<strong>${p.name}</strong>`;
            if(idx === currentPlayerIndex) html += " <span style='color:#69f0ae; font-size:0.8em'>â—€ é¸æŠä¸­</span>";
            pDiv.innerHTML = html;
            
            const bowlDiv = document.createElement('div');
            p.bowl.forEach(ing => {
                // æ‰‹å…ƒã®ä¸­èº« (isRevealedã¯trueã«ãªã£ã¦ã„ã‚‹ã®ã§åå‰ãŒå‡ºã‚‹)
                const ingEl = ing.getElement(null, false);
                ingEl.style.transform = "scale(0.9)";
                ingEl.style.margin = "2px";
                bowlDiv.appendChild(ingEl);
            });
            pDiv.appendChild(bowlDiv);
            playersEl.appendChild(pDiv);
        });
        
        document.getElementById('instruction').innerText = `ğŸ‘‰ ${players[currentPlayerIndex].name} ã®ç•ªã§ã™ã€‚`;
    }

    // çµæœç”»é¢
    function startResultPhase() {
        phase = 3;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        players.forEach(p => {
            p.score = p.bowl.reduce((sum, ing) => sum + ing.score, 0);
        });
        players.sort((a, b) => b.score - a.score);

        const resultList = document.getElementById('result-list');
        let html = '<table border="1" cellpadding="8" style="margin: 0 auto; border-collapse: collapse; width: 95%; background-color:#333;">';
        html += '<tr style="background-color:#444;"><th>é †ä½</th><th>åå‰</th><th>å¾—ç‚¹</th><th>å†…è¨³</th></tr>';

        players.forEach((p, rank) => {
            html += `<tr>
                <td style="font-size:1.2em; font-weight:bold; text-align:center;">${rank + 1}ä½</td>
                <td style="text-align:center;">${p.name}</td>
                <td style="font-size:1.3em; font-weight:bold; color:#ffd54f; text-align:center;">${p.score}</td>
                <td style="text-align:left;">
                    <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                   ${p.bowl.map(i => i.getElement(null, false).outerHTML).join('')}
                   </div>
                </td>
            </tr>`;
        });
        html += '</table>';
        resultList.innerHTML = html;
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æç”»
    function renderLegend() {
        const container = document.getElementById('legend-container');
        container.innerHTML = '';
        INGREDIENT_DEFINITIONS.forEach(def => {
            const row = document.createElement('div');
            row.className = 'legend-row';
            row.innerHTML = `<div class="ingredient shape-${def.shape} color-${def.color}" style="transform:scale(0.8)"></div>
                             <div class="legend-info">${def.items.map(i=>`${i.name}(${i.score})`).join(', ')}</div>`;
            container.appendChild(row);
        });
        // èŒ¶è‰²SP
        const row = document.createElement('div');
        row.className = 'legend-row';
        row.innerHTML = `<div class="ingredient shape-sphere color-brown" style="transform:scale(0.8); border-radius:20%">?</div>
                         <div class="legend-info" style="color:#ffcc80">SP: é»’æ¯›å’Œç‰›(4), ã‚´ã‚­ãƒ–ãƒª(-4)</div>`;
        container.appendChild(row);
    }
</script>
</body>
</html>
