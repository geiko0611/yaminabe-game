<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é—‡é‹ã‚²ãƒ¼ãƒ  (æ–°å…·æver)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #222; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #main-area { flex: 1; padding: 10px; overflow-y: auto; text-align: center; position: relative; }
        #sidebar { 
            width: 300px; 
            background-color: #2d2d2d; 
            border-left: 1px solid #444; 
            overflow-y: auto; 
            display: none; 
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }
        @media (min-width: 800px) { #sidebar { display: flex; } }

        h1 { margin: 10px 0; font-size: 1.2em; letter-spacing: 2px; }
        
        /* ãƒœã‚¿ãƒ³ãªã© */
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background-color: #eee; border: none; border-radius: 4px; margin: 10px; color:#333; font-weight: bold;}
        button:hover { background-color: #fff; }
        .hidden { display: none !important; }

        /* å…·æã‚¹ã‚¿ã‚¤ãƒ« */
        .ingredient {
            width: 44px; height: 44px;
            display: inline-flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.6);
            font-size: 9px; color: #000; font-weight: bold; overflow: hidden; margin: 4px;
            transition: transform 0.1s;
        }
        .ingredient:hover { transform: scale(1.1); z-index: 10; }

        /* å½¢ã®å®šç¾© */
        .shape-sphere { border-radius: 50%; }
        .shape-cube { border-radius: 4px; }
        .shape-pyramid { 
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); 
            width: 48px; height: 44px; 
            border-radius: 0;
            padding-top: 10px; /* æ–‡å­—ä½ç½®èª¿æ•´ */
        }
        
        /* è‰²ã®å®šç¾© */
        .color-white { background-color: #f5f5f5; border: 1px solid #bbb; }
        .color-green { background-color: #69f0ae; }
        .color-red { background-color: #ff5252; }
        .color-brown { background-color: #795548; border: 1px solid #d7ccc8; color: #fff; }

        /* å…·æåè¡¨ç¤ºï¼ˆã™ãã£ãŸå¾Œï¼‰ */
        .revealed-content {
            font-size: 9px; line-height: 1.1; text-align: center; word-break: break-all;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none;
        }
        .shape-pyramid .revealed-content {
            padding-top: 10px; /* ä¸‰è§’å½¢ç”¨ã®ä½ç½®èª¿æ•´ */
        }
        
        /* é‹ã‚¨ãƒªã‚¢ */
        #pot-area {
            background-color: #3e2723; border-radius: 50%;
            width: 320px; height: 320px; margin: 10px auto; padding: 30px;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            border: 8px solid #5d4037; box-shadow: inset 0 0 50px #000;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ */
        .player-area {
            border: 1px solid #555; margin: 5px; padding: 8px; border-radius: 8px;
            background-color: #2a2a2a; display: inline-block; vertical-align: top;
            width: 45%; min-height: 90px; font-size: 0.9em;
        }
        .active-turn { border: 2px solid #69f0ae; background-color: #333; box-shadow: 0 0 10px rgba(105, 240, 174, 0.3); }

        /* ãƒ­ã‚° */
        #log { margin-top: 20px; color: #aaa; font-size: 0.85em; height: 100px; overflow-y: auto; border-top: 1px solid #444; text-align: left; padding: 10px; font-family: monospace;}
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar-header { padding: 15px; background-color: #222; text-align: center; font-weight: bold; border-bottom: 1px solid #444; }
        .legend-group { padding: 10px; border-bottom: 1px solid #444; }
        .legend-title { display: flex; align-items: center; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;}
        .legend-items { font-size: 0.8em; color: #ccc; line-height: 1.4; padding-left: 5px;}
        
        /* å¾—ç‚¹ã®è‰²åˆ†ã‘ */
        .pt-plus { color: #81c784; }
        .pt-minus { color: #e57373; }
        .pt-bad { color: #ef5350; font-weight: bold; }
        .pt-great { color: #ffd54f; font-weight: bold;}
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">ğŸ² å…·æãƒ»å¾—ç‚¹è¡¨</div>
    <div id="legend-container"></div>
</div>

<div id="main-area">
    <h1>é—‡é‹ã‚²ãƒ¼ãƒ </h1>
    
    <div id="setup-screen">
        <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°</p>
        <select id="player-count" style="padding:10px; font-size:1.2em; width: 100px;">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4" selected>4äºº</option>
            <option value="5">5äºº</option>
            <option value="6">6äºº</option>
        </select>
        <br><br>
        <button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <p style="color:#aaa; font-size:0.9em;">
            å…¨40å€‹å‰å¾Œã®å…·æã‹ã‚‰ã€<br>
            äººæ•°Ã—5å€‹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
            (æ®‹ã‚Šã¯ä½¿ç”¨ã—ã¾ã›ã‚“)
        </p>
    </div>

    <div id="game-screen" class="hidden">
        <h2 id="phase-display">ãƒ•ã‚§ãƒ¼ã‚º2: é‹ã‹ã‚‰ã™ãã†</h2>
        <p id="instruction">æº–å‚™ä¸­...</p>
        
        <div>
            <div id="pot-area"></div>
            <div style="color:#aaa; margin-top:5px;">é‹ã®æ®‹ã‚Š: <span id="pot-count" style="font-weight:bold; color:#fff;">0</span> å€‹</div>
        </div>

        <div id="players-container" style="margin-top:20px;"></div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>çµæœç™ºè¡¨</h2>
        <div id="result-list"></div>
        <button onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>

    <div id="log"></div>
</div>

<script>
    /* =========================================
       ãƒ‡ãƒ¼ã‚¿å®šç¾© (æ–°å…·æãƒªã‚¹ãƒˆ)
       â€»countã¯å‡ºç¾ç¢ºç‡ã®é‡ã¿ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™
       ========================================= */
    const INGREDIENT_DEFINITIONS = [
        // 1. ç™½ã„ç«‹æ–¹ä½“ (å®‰ç‰Œ)
        { 
            label: "ç™½ã„ç«‹æ–¹ä½“ (å®‰ç‰Œ)",
            color: 'white', shape: 'cube', 
            items: [
                {name:'åµ', score:1, count:2},
                {name:'å¤§æ ¹', score:1, count:2},
                {name:'è±†è…', score:1, count:2},
                {name:'ç™½æ¡ƒ', score:2, count:1},
                {name:'é¤…', score:2, count:1},
                {name:'ã«ã‚“ã«ã', score:1, count:1},
                {name:'ãƒ†ã‚£ãƒƒã‚·ãƒ¥', score:-1, count:1} // NEW
            ]
        },
        // 2. ç·‘ã®ä¸‰è§’éŒ (æ™®é€š)
        { 
            label: "ç·‘ã®ä¸‰è§’éŒ (æ™®é€š)",
            color: 'green', shape: 'pyramid', 
            items: [
                {name:'ã­ã', score:1, count:2},
                {name:'ã‚­ãƒ£ãƒ™ãƒ„', score:1, count:2},
                {name:'ãƒ‹ãƒ©', score:1, count:2},
                {name:'ã‚­ã‚¦ã‚¤', score:2, count:1},
                {name:'ã‚¹ãƒ©ã‚¤ãƒ ', score:-2, count:1}
            ]
        },
        // 3. èµ¤ã„çƒ (ã¡ã‚‡ã£ã¨å±é™º)
        { 
            label: "èµ¤ã„çƒ (ã¡ã‚‡ã£ã¨å±é™º)",
            color: 'red', shape: 'sphere', 
            items: [
                {name:'ãƒˆãƒãƒˆ', score:1, count:2},
                {name:'ã«ã‚“ã˜ã‚“', score:1, count:2},
                {name:'ã„ã¡ã”', score:2, count:1},
                {name:'ã‚«ãƒ‹', score:3, count:1},
                {name:'ç”Ÿè‚‰', score:-2, count:2},
                {name:'å”è¾›å­', score:-2, count:1} // NEW
            ]
        },
        // 4. èŒ¶è‰²ã„ä¸‰è§’éŒ (ãƒ¤ãƒã‚¹)
        { 
            label: "èŒ¶è‰²ã„ä¸‰è§’éŒ (ãƒ¤ãƒã‚¹)",
            color: 'brown', shape: 'pyramid', 
            items: [
                {name:'é»’æ¯›å’Œç‰›', score:4, count:1},
                {name:'æ¾èŒ¸', score:3, count:1}, // NEW
                {name:'ã‚´ã‚­ãƒ–ãƒª', score:-4, count:1},
                {name:'ãŸã‚ã—', score:-3, count:1}, // NEW
                {name:'ã‚¿ã‚¤ãƒ¤', score:-4, count:1}  // NEW
            ]
        }
    ];

    let players = [];
    let potIngredients = [];
    let currentPlayerIndex = 0;
    let phase = 0;

    // ãƒ­ã‚°æ©Ÿèƒ½
    function log(msg) {
        const el = document.getElementById('log');
        const time = new Date().toLocaleTimeString().slice(3,8);
        el.innerHTML = `<div><span style="color:#666">[${time}]</span> ${msg}</div>` + el.innerHTML;
    }

    // å…·æã‚¯ãƒ©ã‚¹
    class Ingredient {
        constructor(shape, color, name, score) {
            this.shape = shape;
            this.color = color;
            this.name = name;
            this.score = score;
            this.isRevealed = false;
            this.id = Math.random().toString(36).substr(2, 9);
        }

        getElement(onClick, enableClick = true) {
            const el = document.createElement('div');
            el.className = `ingredient shape-${this.shape} color-${this.color}`;
            
            if(this.isRevealed) {
                // æ­£ä½“åˆ¤æ˜æ™‚
                el.title = `${this.name} (${this.score}ç‚¹)`;
                // æ–‡å­—è‰²èª¿æ•´
                const textColor = (this.color === 'brown' || this.color === 'red') ? '#fff' : '#000';
                
                el.innerHTML = `
                    <div class="revealed-content" style="color:${textColor}">
                        <span>${this.name}</span>
                        <span style="font-size:0.9em; font-weight:bold;">${this.score}</span>
                    </div>`;
            } else {
                // éš è”½æ™‚
                el.title = `?`;
            }

            if (enableClick && onClick) el.onclick = () => onClick(this);
            return el;
        }
    }

    // ãƒ‡ãƒƒã‚­ç”Ÿæˆ
    function generateIngredientDeck() {
        let deck = [];
        INGREDIENT_DEFINITIONS.forEach(def => {
            def.items.forEach(item => {
                for(let i=0; i<item.count; i++) {
                    deck.push(new Ingredient(def.shape, def.color, item.name, item.score));
                }
            });
        });
        return deck;
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
        const count = parseInt(document.getElementById('player-count').value);
        players = [];
        for(let i=0; i<count; i++) players.push({ id: i, name: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, bowl: [], score: 0 });

        let allIngredients = generateIngredientDeck();
        allIngredients.sort(() => Math.random() - 0.5);
        
        const requiredIngredients = count * 5;
        // ã‚‚ã—å…·æãŒè¶³ã‚Šãªã„å ´åˆã¯å…¨é‡ä½¿ã†
        potIngredients = allIngredients.slice(0, Math.min(requiredIngredients, allIngredients.length));

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        log(`ã‚²ãƒ¼ãƒ é–‹å§‹ï¼å…·ææ•°: ${potIngredients.length}å€‹`);
        renderLegend();
        updateBoard();
    }

    // å…·æé¸æŠå‡¦ç†
    function scoopIngredient(ingredient) {
        if (phase === 3) return; 

        const index = potIngredients.findIndex(i => i.id === ingredient.id);
        if (index === -1) return;
        
        // 1. é‹ã‹ã‚‰å‰Šé™¤
        potIngredients.splice(index, 1);

        // 2. æ­£ä½“ã‚’æ˜ã‹ã™ (å³æ™‚é–‹ç¤º)
        ingredient.isRevealed = true;

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 
        const player = players[currentPlayerIndex];
        player.bowl.push(ingredient);
        
        // ç‚¹æ•°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const ptStr = ingredient.score > 0 ? `+${ingredient.score}` : ingredient.score;
        log(`${player.name} ãŒ <strong>ã€${ingredient.name} (${ptStr})ã€‘</strong> ã‚’å¼•ãã¾ã—ãŸï¼`);

        // ã‚¿ãƒ¼ãƒ³é€ã‚Š
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

        if (potIngredients.length === 0) {
            startResultPhase();
        } else {
            updateBoard();
        }
    }

    // ç”»é¢æ›´æ–°
    function updateBoard() {
        const potEl = document.getElementById('pot-area');
        potEl.innerHTML = '';
        document.getElementById('pot-count').innerText = potIngredients.length;

        // é‹ã®ä¸­èº« (éš ã‚ŒãŸçŠ¶æ…‹)
        potIngredients.forEach(ing => {
            potEl.appendChild(ing.getElement((i) => scoopIngredient(i), true));
        });

        const playersEl = document.getElementById('players-container');
        playersEl.innerHTML = '';
        players.forEach((p, idx) => {
            const pDiv = document.createElement('div');
            pDiv.className = `player-area ${idx === currentPlayerIndex ? 'active-turn' : ''}`;
            
            let html = `<strong>${p.name}</strong>`;
            if(idx === currentPlayerIndex) html += " <span style='color:#69f0ae; font-size:0.8em'>â—€ é¸æŠä¸­</span>";
            pDiv.innerHTML = html;
            
            const bowlDiv = document.createElement('div');
            p.bowl.forEach(ing => {
                // æ‰‹å…ƒ (é–‹ç¤ºçŠ¶æ…‹)
                const ingEl = ing.getElement(null, false);
                ingEl.style.transform = "scale(0.9)";
                ingEl.style.margin = "2px";
                bowlDiv.appendChild(ingEl);
            });
            pDiv.appendChild(bowlDiv);
            playersEl.appendChild(pDiv);
        });
        
        document.getElementById('instruction').innerText = `ğŸ‘‰ ${players[currentPlayerIndex].name} ã®ç•ªã§ã™`;
    }

    // çµæœç”»é¢
    function startResultPhase() {
        phase = 3;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        players.forEach(p => {
            p.score = p.bowl.reduce((sum, ing) => sum + ing.score, 0);
        });
        players.sort((a, b) => b.score - a.score);

        const resultList = document.getElementById('result-list');
        let html = '<table border="1" cellpadding="8" style="margin: 0 auto; border-collapse: collapse; width: 95%; background-color:#333; color:#fff;">';
        html += '<tr style="background-color:#444;"><th>é †ä½</th><th>åå‰</th><th>å¾—ç‚¹</th><th>å†…è¨³</th></tr>';

        players.forEach((p, rank) => {
            html += `<tr>
                <td style="font-size:1.2em; font-weight:bold; text-align:center;">${rank + 1}ä½</td>
                <td style="text-align:center;">${p.name}</td>
                <td style="font-size:1.3em; font-weight:bold; color:#ffd54f; text-align:center;">${p.score}</td>
                <td style="text-align:left;">
                   <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                   ${p.bowl.map(i => i.getElement(null, false).outerHTML).join('')}
                   </div>
                </td>
            </tr>`;
        });
        html += '</table>';
        resultList.innerHTML = html;
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼(å¾—ç‚¹è¡¨)æç”»
    function renderLegend() {
        const container = document.getElementById('legend-container');
        container.innerHTML = '';
        
        // ç‚¹æ•°ç€è‰²ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const fmt = (score) => {
            let cls = '';
            if(score >= 4) cls = 'pt-great';
            else if(score > 0) cls = 'pt-plus';
            else if(score <= -4) cls = 'pt-bad';
            else cls = 'pt-minus';
            return `<span class="${cls}">${score>0?'+':''}${score}</span>`;
        };

        INGREDIENT_DEFINITIONS.forEach(def => {
            const row = document.createElement('div');
            row.className = 'legend-group';
            
            // ã‚¢ã‚¤ã‚³ãƒ³
            const iconHtml = `<div class="ingredient shape-${def.shape} color-${def.color}" style="transform:scale(0.8); margin-right:5px; cursor:default;"></div>`;
            
            // å†…è¨³ãƒ†ã‚­ã‚¹ãƒˆ
            const itemsHtml = def.items.map(i => `${i.name}(${fmt(i.score)})`).join(', ');

            row.innerHTML = `
                <div class="legend-title">${iconHtml} ${def.label}</div>
                <div class="legend-items">${itemsHtml}</div>
            `;
            container.appendChild(row);
        });
    }
</script>
</body>
</html>
