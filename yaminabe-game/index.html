<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é—‡é‹ã‚²ãƒ¼ãƒ  v4</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #222; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */
        #main-area { flex: 1; padding: 20px; overflow-y: auto; text-align: center; position: relative; }
        #sidebar { 
            width: 320px; 
            background-color: #2d2d2d; 
            border-left: 1px solid #444; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        h1 { margin-top: 0; font-size: 1.5em; letter-spacing: 2px; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆå…·æãƒªã‚¹ãƒˆï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .sidebar-header {
            padding: 15px;
            background-color: #222;
            border-bottom: 1px solid #444;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .legend-group {
            padding: 10px;
            border-bottom: 1px solid #3d3d3d;
        }
        .legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-icon-container {
            width: 50px;
            text-align: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .legend-info {
            flex-grow: 1;
            font-size: 0.85em;
        }
        .legend-title {
            font-weight: bold;
            color: #ddd;
            margin-bottom: 2px;
            font-size: 0.95em;
        }
        .legend-detail {
            color: #aaa;
            line-height: 1.3;
        }
        .pt-plus { color: #81c784; }
        .pt-minus { color: #e57373; }
        .pt-bad { color: #ef5350; font-weight: bold; }
        .pt-great { color: #ffd54f; font-weight: bold;}

        /* å…·æã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå…±é€šï¼‰ */
        .ingredient {
            width: 36px;
            height: 36px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            font-size: 9px;
            color: #000;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            margin: 2px;
        }
        
        /* ç›¤é¢ä¸Šã®å…·æã¯å°‘ã—å¤§ãã */
        #pot-area .ingredient, .player-area .ingredient {
            width: 45px;
            height: 45px;
            margin: 5px;
        }

        /* å½¢ã®å®šç¾© */
        .shape-sphere { border-radius: 50%; }
        .shape-cube { border-radius: 3px; }
        .shape-pyramid { 
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            width: 40px; height: 36px; /* ç¸¦æ¨ªæ¯”èª¿æ•´ */
            border-radius: 0;
        }
        /* ç›¤é¢ä¸Šã®ä¸‰è§’ */
        #pot-area .shape-pyramid, .player-area .shape-pyramid {
            width: 50px; height: 45px;
        }

        /* è‰²ã®å®šç¾© */
        .color-red { background-color: #ff6b6b; }
        .color-green { background-color: #69f0ae; }
        .color-yellow { background-color: #ffd740; }
        .color-white { background-color: #f5f5f5; border: 1px solid #999; }
        .color-brown { background-color: #795548; border: 1px solid #d7ccc8; color: #fff; }

        /* ã‚¨ãƒªã‚¢å®šç¾© */
        #pot-area {
            background-color: #3e2723;
            border-radius: 50%;
            width: 400px;
            height: 400px;
            margin: 10px auto;
            padding: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            border: 8px solid #5d4037;
            box-shadow: inset 0 0 40px #000;
        }

        .player-area {
            border: 1px solid #555;
            margin: 5px;
            padding: 8px;
            border-radius: 8px;
            background-color: #2a2a2a;
            display: inline-block;
            vertical-align: top;
            width: 45%;
            min-height: 80px;
        }
        .active-turn { border: 2px solid #69f0ae; background-color: #333; box-shadow: 0 0 10px rgba(105, 240, 174, 0.3); }
        
        button { padding: 10px 24px; font-size: 16px; cursor: pointer; background-color: #eee; border: none; border-radius: 4px; margin-top: 10px; color:#333; font-weight: bold;}
        button:hover { background-color: #fff; }

        #log { margin-top: 20px; color: #888; font-size: 0.85em; height: 80px; overflow-y: scroll; border-top: 1px solid #444; text-align: left; padding: 10px; font-family: monospace;}
        .hidden { display: none; }
        .revealed-name { font-size: 9px; line-height: 1; pointer-events: none;}
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">ğŸ² å…·æãƒ»å¾—ç‚¹è¡¨</div>
    <div id="legend-container">
        </div>
</div>

<div id="main-area">
    <h1>é—‡é‹ã‚²ãƒ¼ãƒ </h1>
    
    <div id="setup-screen">
        <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <select id="player-count" style="padding:5px; font-size:1.2em;">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4" selected>4äºº</option>
            <option value="5">5äºº</option>
            <option value="6">6äºº</option>
        </select>
        <br><br>
        <button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <p style="color:#aaa;"><small>å…¨40å€‹ã®å…·æã‹ã‚‰ã€äººæ•°Ã—5å€‹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>æ®‹ã‚Šã¯ã‚²ãƒ¼ãƒ ã«ä½¿ã‚ã‚Œã¾ã›ã‚“ã€‚</small></p>
    </div>

    <div id="game-screen" class="hidden">
        <h2 id="phase-display">ãƒ•ã‚§ãƒ¼ã‚º2: é‹ã‹ã‚‰å…·æã‚’ã™ãã†</h2>
        <p id="instruction">æº–å‚™ä¸­...</p>
        
        <div>
            <div id="pot-area"></div>
            <div style="margin-top:5px; color:#aaa;">é‹ã®æ®‹ã‚Š: <span id="pot-count" style="font-weight:bold; color:#fff;">0</span> å€‹</div>
        </div>

        <div id="players-container" style="margin-top:20px;"></div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>å®Ÿé£Ÿã‚¿ã‚¤ãƒ çµ‚äº†ï¼çµæœç™ºè¡¨</h2>
        <div id="result-list"></div>
        <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <div id="log"></div>
</div>

<script>
    /* =========================================
       ãƒ‡ãƒ¼ã‚¿å®šç¾©
       ========================================= */
    
    // åŸºæœ¬å…·æï¼ˆ36å€‹ï¼‰
    const INGREDIENT_DEFINITIONS = [
        // èµ¤ (Red)
        { color: 'red', shape: 'sphere', total: 3, items: [{name:'ãƒˆãƒãƒˆ', score:1, count:2}, {name:'ã„ã¡ã”', score:2, count:1}] },
        { color: 'red', shape: 'pyramid', total: 3, items: [{name:'ã«ã‚“ã˜ã‚“', score:1, count:3}] },
        { color: 'red', shape: 'cube', total: 3, items: [{name:'ç”Ÿè‚‰', score:-2, count:2}, {name:'ã‚«ãƒ‹', score:3, count:1}] },
        
        // ç·‘ (Green)
        { color: 'green', shape: 'sphere', total: 3, items: [{name:'ãƒã‚®', score:1, count:2}, {name:'ã‚­ã‚¦ã‚¤', score:2, count:1}] },
        { color: 'green', shape: 'pyramid', total: 3, items: [{name:'ã‚­ãƒ£ãƒ™ãƒ„', score:1, count:2}, {name:'ã‚¹ãƒ©ã‚¤ãƒ ', score:-2, count:1}] },
        { color: 'green', shape: 'cube', total: 3, items: [{name:'ãƒ‹ãƒ©', score:1, count:3}] },

        // é»„ (Yellow)
        { color: 'yellow', shape: 'sphere', total: 3, items: [{name:'ã‚¸ãƒ£ã‚¬ã‚¤ãƒ¢', score:1, count:3}] },
        { color: 'yellow', shape: 'pyramid', total: 3, items: [{name:'ã‹ã¼ã¡ã‚ƒ', score:1, count:2}, {name:'ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«', score:2, count:1}] },
        { color: 'yellow', shape: 'cube', total: 3, items: [{name:'åšæšã’', score:1, count:2}, {name:'ã‚¹ãƒãƒ³ã‚¸', score:-2, count:1}] },

        // ç™½ (White)
        { color: 'white', shape: 'sphere', total: 3, items: [{name:'ã‚†ã§åµ', score:1, count:2}, {name:'ç™½æ¡ƒ', score:2, count:1}] },
        { color: 'white', shape: 'pyramid', total: 3, items: [{name:'å¤§æ ¹', score:1, count:2}, {name:'ãƒ‹ãƒ³ãƒ‹ã‚¯', score:1, count:1}] },
        { color: 'white', shape: 'cube', total: 3, items: [{name:'è±†è…', score:1, count:2}, {name:'é¤…', score:2, count:1}] },
    ];

    // ã‚¹ãƒšã‚·ãƒ£ãƒ«å…·æï¼ˆèŒ¶è‰²ã¯å½¢ãŒãƒ©ãƒ³ãƒ€ãƒ ãªã®ã§åˆ¥æ å®šç¾©ã€åˆè¨ˆ4å€‹ï¼‰
    const BROWN_ITEMS = [
        {name:'é»’æ¯›å’Œç‰›', score:4, count:2},
        {name:'ã‚´ã‚­ãƒ–ãƒª', score:-4, count:2}
    ];

    const SHAPES = ['sphere', 'cube', 'pyramid'];
    
    /* =========================================
       ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
       ========================================= */

    let players = [];
    let potIngredients = [];
    let currentPlayerIndex = 0;
    let phase = 0;

    // ãƒ­ã‚°è¡¨ç¤º
    function log(msg) {
        const el = document.getElementById('log');
        el.innerHTML = `<div><span style="color:#666">[${new Date().toLocaleTimeString().slice(3,8)}]</span> ${msg}</div>` + el.innerHTML;
    }

    // å…·æã‚¯ãƒ©ã‚¹
    class Ingredient {
        constructor(shape, color, name, score, isRevealed = false) {
            this.shape = shape;
            this.color = color;
            this.name = name;
            this.score = score;
            this.isRevealed = isRevealed;
            this.id = Math.random().toString(36).substr(2, 9);
        }

        getElement(onClick, enableClick = true) {
            const el = document.createElement('div');
            el.className = `ingredient shape-${this.shape} color-${this.color}`;
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
            if(this.isRevealed) {
                el.title = `${this.name} (${this.score}ç‚¹)`;
                const text = document.createElement('span');
                text.className = 'revealed-name';
                text.innerText = this.name;
                el.appendChild(text);
            } else {
                el.title = `è‰²:${this.color} å½¢:${this.shape}`;
            }

            if (enableClick && onClick) el.onclick = () => onClick(this);
            return el;
        }
    }

    // ãƒ‡ãƒƒã‚­ç”Ÿæˆ
    function generateIngredientDeck() {
        let deck = [];
        
        // 1. åŸºæœ¬å…·æ
        INGREDIENT_DEFINITIONS.forEach(def => {
            def.items.forEach(itemInfo => {
                for(let i=0; i<itemInfo.count; i++){
                    deck.push(new Ingredient(def.shape, def.color, itemInfo.name, itemInfo.score));
                }
            });
        });

        // 2. èŒ¶è‰²å…·æï¼ˆå½¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ å‰²ã‚Šå½“ã¦ï¼‰
        BROWN_ITEMS.forEach(itemInfo => {
            for(let i=0; i<itemInfo.count; i++){
                const randomShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
                deck.push(new Ingredient(randomShape, 'brown', itemInfo.name, itemInfo.score));
            }
        });

        return deck;
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æç”»ï¼ˆå¾—ç‚¹è¡¨ï¼‰
    function renderLegend() {
        const container = document.getElementById('legend-container');
        container.innerHTML = '';

        // ç‚¹æ•°ã«è‰²ã‚’ã¤ã‘ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const fmtScore = (score) => {
            let cls = '';
            if(score >= 4) cls = 'pt-great';
            else if(score > 0) cls = 'pt-plus';
            else if(score <= -4) cls = 'pt-bad';
            else cls = 'pt-minus';
            return `<span class="${cls}">${score > 0 ? '+' : ''}${score}</span>`;
        };

        // 1. åŸºæœ¬å…·æã®ãƒªã‚¹ãƒˆç”Ÿæˆ
        INGREDIENT_DEFINITIONS.forEach(def => {
            const row = document.createElement('div');
            row.className = 'legend-group';
            
            // å†…è¨³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            const itemsText = def.items.map(it => `${it.name}(${fmtScore(it.score)})Ã—${it.count}`).join(', ');

            row.innerHTML = `
                <div class="legend-row">
                    <div class="legend-icon-container">
                        <div class="ingredient shape-${def.shape} color-${def.color}"></div>
                    </div>
                    <div class="legend-info">
                        <div class="legend-title">è¨ˆ${def.total}å€‹</div>
                        <div class="legend-detail">${itemsText}</div>
                    </div>
                </div>
            `;
            container.appendChild(row);
        });

        // 2. èŒ¶è‰²ï¼ˆã‚¹ãƒšã‚·ãƒ£ãƒ«ï¼‰ã®ãƒªã‚¹ãƒˆç”Ÿæˆ
        const brownRow = document.createElement('div');
        brownRow.className = 'legend-group';
        const brownItemsText = BROWN_ITEMS.map(it => `${it.name}(${fmtScore(it.score)})Ã—${it.count}`).join('<br>');
        
        brownRow.innerHTML = `
             <div class="legend-row">
                <div class="legend-icon-container">
                    <div class="ingredient shape-sphere color-brown" style="border-radius:20%">?</div>
                </div>
                <div class="legend-info">
                    <div class="legend-title" style="color:#ffcc80">SP: èŒ¶è‰² (å½¢ã¯ãƒ©ãƒ³ãƒ€ãƒ )</div>
                    <div class="legend-detail" style="font-size:1em;">${brownItemsText}</div>
                </div>
            </div>
        `;
        container.appendChild(brownRow);
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
    function startGame() {
        const count = parseInt(document.getElementById('player-count').value);
        
        players = [];
        for(let i=0; i<count; i++) {
            players.push({ id: i, name: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, bowl: [], score: 0 });
        }

        let allIngredients = generateIngredientDeck();
        log(`ãƒ‡ãƒƒã‚­ç”Ÿæˆå®Œäº†: åˆè¨ˆ${allIngredients.length}å€‹`);
        
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        allIngredients.sort(() => Math.random() - 0.5);

        // é‹ã«æŠ•å…¥
        const requiredIngredients = count * 5;
        potIngredients = allIngredients.slice(0, requiredIngredients);

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        renderLegend(); // å¾—ç‚¹è¡¨æç”»
        startScoopingPhase();
    }

    // ãƒ•ã‚§ãƒ¼ã‚º2
    function startScoopingPhase() {
        phase = 2;
        updateBoard();
    }

    // å…·æé¸æŠ
    function scoopIngredient(ingredient) {
        if (phase !== 2) return;

        const index = potIngredients.findIndex(i => i.id === ingredient.id);
        if (index === -1) return;
        potIngredients.splice(index, 1);

        const player = players[currentPlayerIndex];
        player.bowl.push(ingredient);
        
        log(`${player.name} ãŒé¸æŠã—ã¾ã—ãŸã€‚`);

        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;

        if (potIngredients.length === 0) {
            startEatingPhase();
        } else {
            updateBoard();
        }
    }

    // ç›¤é¢æ›´æ–°
    function updateBoard() {
        const potEl = document.getElementById('pot-area');
        potEl.innerHTML = '';
        document.getElementById('pot-count').innerText = potIngredients.length;

        potIngredients.forEach(ing => {
            potEl.appendChild(ing.getElement((i) => scoopIngredient(i), true));
        });

        const playersEl = document.getElementById('players-container');
        playersEl.innerHTML = '';
        players.forEach((p, idx) => {
            const pDiv = document.createElement('div');
            pDiv.className = `player-area ${idx === currentPlayerIndex ? 'active-turn' : ''}`;
            
            let html = `<strong>${p.name}</strong>`;
            if(idx === currentPlayerIndex) html += " <span style='color:#69f0ae; font-size:0.8em'>â—€ é¸æŠä¸­</span>";
            pDiv.innerHTML = html;
            
            const bowlDiv = document.createElement('div');
            p.bowl.forEach(ing => {
                const ingEl = ing.getElement(null, false);
                ingEl.style.transform = "scale(0.8)";
                ingEl.style.margin = "2px";
                bowlDiv.appendChild(ingEl);
            });
            pDiv.appendChild(bowlDiv);
            playersEl.appendChild(pDiv);
        });
        
        document.getElementById('instruction').innerText = `ğŸ‘‰ ${players[currentPlayerIndex].name} ã®ç•ªã§ã™ã€‚é‹ã‹ã‚‰å…·æã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`;
    }

    // ãƒ•ã‚§ãƒ¼ã‚º3: å®Ÿé£Ÿ
    function startEatingPhase() {
        phase = 3;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        players.forEach(p => {
            p.bowl.forEach(ing => ing.isRevealed = true);
            p.score = p.bowl.reduce((sum, ing) => sum + ing.score, 0);
        });

        players.sort((a, b) => b.score - a.score);

        const resultList = document.getElementById('result-list');
        let html = '<table border="1" cellpadding="8" style="margin: 0 auto; border-collapse: collapse; width: 95%; background-color:#333; color:#fff;">';
        html += '<tr style="background-color:#444;"><th>é †ä½</th><th>åå‰</th><th>å¾—ç‚¹</th><th>é£Ÿã¹ãŸå…·æ</th></tr>';

        players.forEach((p, rank) => {
            html += `<tr>
                <td style="font-size:1.2em; font-weight:bold; text-align:center;">${rank + 1}ä½</td>
                <td style="text-align:center;">${p.name}</td>
                <td style="font-size:1.3em; font-weight:bold; color:#ffd54f; text-align:center;">${p.score}</td>
                <td style="text-align:left;">
                    <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                   ${p.bowl.map(i => i.getElement(null, false).outerHTML).join('')}
                   </div>
                </td>
            </tr>`;
        });
        html += '</table>';
        resultList.innerHTML = html;
    }
    
    // åˆæœŸè¡¨ç¤ºã§ãƒªã‚¹ãƒˆã ã‘æç”»ã—ã¦ãŠã
    renderLegend();

</script>

</body>
</html>